# 라미 공정 후 그래핀의 비전센서 기반 품질 평가

@ Author : HanMinwoong

@ project period : 2024.1.8 - 2024.1.26

@ subject : 라미 공정 후 그래핀의 비전센서 기반 품질 평가



[TOC]

## 1. 하드웨어

### 1.1. 하드웨어 구상안

​		결함 종류를 실무에서 관찰해본 결과, 눈에 띄는 큰 결함도 존재하지만, 눈으로 자세히 봐야 보일 정도의 파티클 사이즈의 결함 요소 역시 존재한다. 딥러닝을 활용하여 결함을 감지하기 위해서는, 전자와 후자의 경우에 대한 충분한 수의 데이터셋이 필요하다. 그러나, 후자의 경우에는 눈으로 자세히 봐야할 정도의 작은 사이즈의 데이터이기 때문에, 딥러닝을 적용하여 감지를 하기 보다는, 고전 영상처리를 통한 감지를 진행하고자 했다. 해당 기법은 외란 요소에 굉장히 민감하다는 단점이 존재하기 때문에, 프로파일 및 블라인드 필름을 활용하여 품질 평가를 위한 암실을 제작하고자 했다.

<u>하드웨어 스테이지 3D 모델 형상</u>

<img src="https://github.com/HanMinung/DLIP/assets/99113269/7ecb22a8-5493-4d37-893c-f2eebf42ccd6" alt="image" style="zoom:50%;" />

<u>하드웨어 스펙</u>

1) 프로파일 : 2040 규격, 홀가공 등 필요한 가공 외주
2) 아크릴 플레이트 : 5T, 210[mm]x460[mm] , 홀가공 위한 .dwg 파일 제작
3) 카메라 - 카메라 결합부 고정 : 1/4 인치 볼트 (6.35 mm)
4) 프로파일 간의 결합 : 홀 / 절단면 가공 결합 및 이너 브라켓 (무드 렌치 볼트) 
5) 후에, 육각렌치 볼트 및 스프링 너트의 결합부는 공차를 고려하여 약 pi5 또는 pi6 정도로 선정/제작을 진행했다.
6) 3차원 모델링에서 볼/너트 결합을 위한 홀을 제작할 때에는 1mm의 공차를 적용하여 프린팅을 진행



### 1.2. 카메라 결합부 제작

​		실제로, assembly를 통해 스테이지를 제작하더라도, 카메라 센서를 완전히 설치하기 전까지는 화각을 고려한 적절한 카메라의 적절한 위치 설정은 어렵다. 그렇기 때문에, 슬라이딩 방식으로 카메라 홀더를 제작하여, 후에 모든 부품을 조립한 뒤에, 카메라 센서의 높낮이를 조절할 수 있는 방식을 고려했다. 서로 결합이 가능하게끔, holder_slider 부품 및 webcam_holder 부품을 각각 제작했다. 각 부품에 대한 3D 형상은 (holder_slider, webcam_holder 순서)은 다음과 같다.

​                                                 <img src="https://github.com/HanMinung/GrapheneSquare_intership/assets/99113269/b710da70-2884-48e9-a4f1-4910339d68c5" alt="image" style="zoom:50%;" />



### 1.3. LED - 프로파일 결합 브라켓 제작

​		스테이지 제작에 활용되는 LED와 프로파일 간의 결합을 위해, 3D 모델링 기반의 브라켓을 제작했다. 환경 변수의 영향을 고정하기 위해서는, 조명의 각도 역시 잘 조절되어야 하는데, 서로 다른 각도의 브라켓을 제작하여, 프린팅을 진행했다. 수평 기준 20 deg 및 40 deg의 각도를 가지는 형상은 다음과 같다.

<img src="https://github.com/HanMinung/DLIP/assets/99113269/599a52e7-3fff-41c5-b6f0-5d93da1ee6f6" alt="image" style="zoom:50%;" />



최종적으로 완성된 하드웨어의 형태는 다음과 같고, 후에, LED 위치 고정을 진행하고, 블라인드 필름을 활용하여 암실 환경을 만들었다.

<img src="https://github.com/HanMinung/DLIP/assets/99113269/c589511f-25db-41ae-9687-80802f77b91f" alt="image" style="zoom:50%;" />





## 2. 소프트웨어

​		기본적인 소프트웨어 시스템을 구축하기 전에, 아두이노의 소프트웨어 flowchart를 정리해보면 다음과 같다.

<img src="https://github.com/HanMinung/DLIP/assets/99113269/01ac16bd-02dd-4e64-bdd8-b99811db5c96" alt="그래핀 품질평가 소프트웨어 흐름도" style="zoom: 67%;" />

카메라의 화각이 샘플 전체를 커버하기가 어렵기 때문에, 각 stage를 정하여, 이동하면서 각 부분에 대한 이미지를 취득하는 과정을 거쳐야 한다. 파이썬 프로세스에서는, 모터의 구동에 따라, 이미지를 취득하여, 리스트에 append를 하고, 마지막에는, append된 이미지를 기반으로 이미지 처리를 진행하고, 품질 평가를 진행하게 된다. 프로그램의 전체적인 구조는 위와 같이 가져갔으며, 실제 카메라의 화각을 고려하여 stage의 수를 정해야 하기 때문에, 실질적으로는 총 5번의 stage에서의 프레임을 취득했다. 



### 2.1. multi thread 구조

​	품질 평가를 진행하는 프로그램은 멀티 쓰레드의 구조를 가진다. 각 프로세스 별로 돌아가는 코드의 역할은 다음과 같다.

* Main thread : 모터 구동 및 아두이노와의 통신 및 프레임 취득 관련 변수 업데이트

* Cam thread : 정해진 state에서의 샘플 이미지 취득 

위와 같이 thread를 나눈 이유는, 프레임 취득을 위해 모터를 구동한 뒤에는 일정 delay를 주게 되는데, 그러한 delay로 인해, 프레임을 정상적으로 받아올 수 없거나 FPS가 과도하게 낮아져 발생하는 문제를 해결하기 위함이다. 이러한 multi thread 구조를 파이썬에서 사용하게 되면, 각 thread마다 공유하는 변수가 있을텐데, 그러한 변수들은 전역 변수로 선언하고 업데이트를 진행한다. 



### 2.2. Image vertical stacking

​	각 stage 마다 취득된 이미지를 os module로 접근하여 특정 경로에 저장하고, 저장된 이미지를 불러와 처리하는 것은 비효율적이다. 그렇기 때문에, 저장되는 이미지를 list에 저장하고, 모두 저장이 되면, 저장된 이미지에 대해 반복을 거쳐 결함을 감지하는 것으로 알고리즘을 구성했다. 최종적으로는, 원본 이미지를 합쳐 최종적인 샘플을 정해진 경로에 저장하게 되고, 각 stage의 프레임에 대해 결함 감지를 진행하고 이어붙인 이미지를 저장하게 된다. 각 stage에서의 사진은 4K 이미지로 저장했으며, 5개의 이미지가 붙여진 최종적인 이미지의 해상도는 다음과 같다 : **3840 X 10800**

마지막 프레임의 경우, ROI를 설정하는 추가적인 과정이 필요하며, 실질적인 수직 해상도는 위 숫자보다 더 작아지게 된다. 생성된 원본 샘플의 사진 및 결함 탐지 결과에 대한 결과 사안은 업로드 하기가 어려운 부분이 있다. 













